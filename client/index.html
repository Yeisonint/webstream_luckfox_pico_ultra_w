<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WebRTC H264 Stream</title>
</head>
<body>
  <h2>WebRTC Video Viewer</h2>
  <canvas id="canvas" width="640" height="480" style="background: black;"></canvas>

  <script>
    const ws = new WebSocket("wss://192.168.50.107:9000");
    const pc = new RTCPeerConnection();
    let decoder = null;
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    pc.ondatachannel = (event) => {
      const dc = event.channel;
      dc.binaryType = "arraybuffer";

      dc.onmessage = (ev) => {
        if (!decoder) {
          decoder = new VideoDecoder({
            output: frame => {
              ctx.drawImage(frame, 0, 0, canvas.width, canvas.height);
              frame.close();
            },
            error: e => console.error("Decoder error:", e)
          });
          decoder.configure({
            codec: "avc1.42E01E"
          });
        }

        decoder.decode(new EncodedVideoChunk({
          type: "key", // simplificado para pruebas
          timestamp: performance.now() * 1000,
          data: new Uint8Array(ev.data)
        }));
      };
    };

    pc.onicecandidate = (event) => {
      if (event.candidate) {
        ws.send(JSON.stringify({ candidate: event.candidate }));
      }
    };

    ws.onmessage = async ({ data }) => {
      const msg = JSON.parse(data);

      if (msg.sdp) {
        await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ sdp: pc.localDescription }));
      } else if (msg.candidate) {
        await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
      }
    };
  </script>
</body>
</html>
